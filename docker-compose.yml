services:
  controller:
    build:
      context: .
      dockerfile: Dockerfile.controller
    ports:
      - "8080:8080"
    environment:
      - LOG_LEVEL=debug
    volumes:
      # Persist git repos if needed, though controller currently clones to /tmp
      # Map templates/static if you want to edit them without rebuilding
      - ./web:/app/web

  agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    environment:
      - CONOPS_CONTROLLER_URL=http://controller:8080
      - AGENT_ID=docker-agent-1
      - POLL_INTERVAL=5s
    volumes:
      # Mount docker socket to allow agent to manage containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount a directory for the agent to store cloned repos/compose files
      - ./conops-agent-data:/app/conops-agent
    depends_on:
      - controller
